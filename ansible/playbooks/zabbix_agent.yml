# ./ansible/playbooks/zabbix_agent.yml
---
- name: üìã Install and configure Zabbix Agent on all hosts
  hosts: all # –í–∞–∂–Ω–æ: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞ –í–°–ï —Ö–æ—Å—Ç—ã
  become: true
  vars:
    zabbix_server_fqdn: "{{ groups['zabbix_server'][0] }}.ru-central1.internal" # –ü–æ–ª—É—á–∞–µ–º FQDN –ø–µ—Ä–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑ –≥—Ä—É–ø–ø—ã

  tasks:
    - name: Install Zabbix agent
      apt:
        name: zabbix-agent
        state: present
        update_cache: yes

    - name: Configure Zabbix agent server (where to send data)
      lineinfile:
        path: /etc/zabbix/zabbix_agentd.conf
        regexp: '^Server='
        line: 'Server={{ zabbix_server_fqdn }}'
        state: present
      notify:
        - Restart Zabbix Agent

    - name: Configure Zabbix agent server for active checks
      lineinfile:
        path: /etc/zabbix/zabbix_agentd.conf
        regexp: '^ServerActive='
        line: 'ServerActive={{ zabbix_server_fqdn }}'
        state: present
      notify:
        - Restart Zabbix Agent

    - name: Configure Zabbix agent Hostname (must be unique)
      lineinfile:
        path: /etc/zabbix/zabbix_agentd.conf
        regexp: '^Hostname='
        line: 'Hostname={{ inventory_hostname }}'
        state: present
      notify:
        - Restart Zabbix Agent

    - name: Start and enable Zabbix agent
      service:
        name: zabbix-agent
        state: started
        enabled: yes

  handlers:
    - name: Restart Zabbix Agent
      service:
        name: zabbix-agent
        state: restarted