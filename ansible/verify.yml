---
- name: 🚀 Quick Infrastructure Verification
  hosts: all
  gather_facts: yes
  tasks:
    - name: Check system health
      shell: |
        echo "Uptime: $(uptime)"
        echo "CPU: $(grep 'cpu ' /proc/stat | awk '{usage=($2+$4)*100/($2+$4+$5)} END {print usage "%"}')"
        echo "Memory: $(free -m | awk 'NR==2{printf "%.2f%%", $3*100/$2}')"
        echo "Disk: $(df -h / | awk 'NR==2{print $5}')"
      register: system_health
      changed_when: false

    - name: Display system health
      debug:
        msg: "{{ inventory_hostname }} - {{ system_health.stdout_lines }}"

- name: 🌐 Verify Web Services
  hosts: web_servers
  tasks:
    - name: Check nginx status
      service_facts:

    - name: Verify nginx
      debug:
        msg: "Nginx status: {{ ansible_facts.services['nginx'].state }}"
      when: ansible_facts.services['nginx'] is defined

    - name: Test website
      uri:
        url: "http://localhost"
        status_code: 200
        timeout: 5
      register: web_test
      ignore_errors: yes

    - name: Website result
      debug:
        msg: "Website HTTP {{ web_test.status }}"

- name: 📊 Verify Monitoring Stack
  hosts: zabbix_server
  tasks:
    - name: Check Zabbix services
      service_facts:

    - name: Verify services
      debug:
        msg: "{{ item }}: {{ ansible_facts.services[item].state }}"
      loop:
        - zabbix-server
        - apache2
        - mysql
      when: ansible_facts.services[item] is defined

- name: 📝 Verify Logging Stack
  hosts: elastic_server:kibana_server
  tasks:
    - name: Check ELK services
      service_facts:

    - name: Verify services
      debug:
        msg: "{{ item }}: {{ ansible_facts.services[item].state }}"
      loop: "{{ ansible_facts.services.keys() | select('match', 'elastic|kibana') | list }}"
      when: ansible_facts.services[item] is defined

- name: ✅ Final Status Report
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Generate summary report
      debug:
        msg: |
          🎯 INFRASTRUCTURE STATUS REPORT
          ==============================
          
          ✅ Web Servers: {{ groups['web_servers'] | length }} servers
          ✅ Monitoring: Zabbix server operational
          ✅ Logging: ELK stack running
          ✅ Agents: Zabbix agents installed on all hosts
          
          📊 Access URLs:
          - Zabbix: http://{{ hostvars['zabbix.ru-central1.internal']['ansible_host'] }}
          - Kibana: http://{{ hostvars['kibana.ru-central1.internal']['ansible_host'] }}:5601
          - Load Balancer: http://158.160.133.132
          
          🚀 Next: Test load balancing and log ingestion